<!DOCTYPE html>
<html class="light" lang="ko">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>CAIO 공개 설정</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&amp;display=swap" rel="stylesheet" />
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#003366",
                        "background-light": "#F7F7F7",
                        "background-dark": "#101922",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0,
                'wght' 400,
                'GRAD' 0,
                'opsz' 24
        }
    </style>
    <style>
        body {
            min-height: max(884px, 100dvh);
        }
    </style>
    <style>
        body {
            min-height: max(884px, 100dvh);
        }
    </style>
    <style>
        body {
            min-height: max(884px, 100dvh);
        }
    </style>
    <style>
        body {
            min-height: max(884px, 100dvh);
        }
    </style>
    <style>
        body {
            min-height: max(884px, 100dvh);
        }
    </style>
</head>

<body class="font-display bg-background-light dark:bg-background-dark">
    <div class="relative flex h-auto min-h-screen w-full flex-col group/design-root overflow-x-hidden">
        <div
            class="flex items-center bg-white dark:bg-background-dark p-4 pb-2 justify-between border-b border-[#E0E0E0] dark:border-gray-700">
            <div class="flex size-12 shrink-0 items-center text-[#333333] dark:text-white">
                <span class="material-symbols-outlined text-2xl">arrow_back</span>
            </div>
            <h2
                class="text-[#333333] dark:text-white text-lg font-bold leading-tight tracking-[-0.015em] flex-1 text-center">
                CAIO 공개 설정</h2>
            <div class="flex w-12 items-center justify-end">
                <p class="text-primary text-base font-bold leading-normal tracking-[0.015em] shrink-0">저장</p>
            </div>
        </div>
        <div class="bg-white dark:bg-background-dark pb-3 pt-4 px-4">
            <p class="text-[#333333] dark:text-gray-300 text-sm font-normal leading-normal">기본적으로 이름, 소속은 공개됩니다. 연락처(휴대폰, 이메일)는 같은 기수에게는 항상 공개되며, 다른 기수에게도 공개할지 설정할 수 있습니다.</p>
        </div>
        <div class="flex flex-col bg-white dark:bg-background-dark divide-y divide-[#E0E0E0] dark:divide-gray-700 mt-2">
            <div class="flex items-center justify-between px-4 py-3 min-h-[56px]">
                <div class="flex-1">
                    <p class="text-[#333333] dark:text-white text-base font-normal leading-normal">이름</p>
                    <p class="text-[#666666] dark:text-gray-400 text-sm leading-tight">항상 공개</p>
                </div>
            </div>
            <div class="flex items-center justify-between px-4 py-3 min-h-[56px]">
                <div class="flex-1">
                    <p class="text-[#333333] dark:text-white text-base font-normal leading-normal">소속</p>
                    <p class="text-[#666666] dark:text-gray-400 text-sm leading-tight">항상 공개</p>
                </div>
            </div>
        </div>
        <div class="flex flex-col bg-white dark:bg-background-dark divide-y divide-[#E0E0E0] dark:divide-gray-700 mt-2">
            <div class="flex items-center justify-between px-4 py-3 min-h-[56px]">
                <div class="flex-1">
                    <p class="text-[#333333] dark:text-white text-base font-normal leading-normal">휴대폰</p>
                    <p class="text-[#666666] dark:text-gray-400 text-sm leading-tight">같은 기수에게는 항상 공개</p>
                </div>
                <div class="flex flex-col items-end gap-1">
                    <label
                        class="relative flex h-[31px] w-[51px] cursor-pointer items-center rounded-full border-none bg-[#CCCCCC] p-0.5 has-[:checked]:justify-end has-[:checked]:bg-primary">
                        <div class="h-full w-[27px] rounded-full bg-white transition-transform"></div>
                        <input id="phoneCheckbox" checked="" class="invisible absolute" type="checkbox" />
                    </label>
                    <p class="text-[#666666] dark:text-gray-400 text-xs">다른 기수에게도 공개</p>
                </div>
            </div>
            <div class="flex items-center justify-between px-4 py-3 min-h-[56px]">
                <div class="flex-1">
                    <p class="text-[#333333] dark:text-white text-base font-normal leading-normal">이메일</p>
                    <p class="text-[#666666] dark:text-gray-400 text-sm leading-tight">같은 기수에게는 항상 공개</p>
                </div>
                <div class="flex flex-col items-end gap-1">
                    <label
                        class="relative flex h-[31px] w-[51px] cursor-pointer items-center rounded-full border-none bg-[#CCCCCC] p-0.5 has-[:checked]:justify-end has-[:checked]:bg-primary">
                        <div class="h-full w-[27px] rounded-full bg-white transition-transform"></div>
                        <input id="emailCheckbox" checked="" class="invisible absolute" type="checkbox" />
                    </label>
                    <p class="text-[#666666] dark:text-gray-400 text-xs">다른 기수에게도 공개</p>
                </div>
            </div>
            <div class="flex items-center justify-between px-4 py-3 min-h-[56px]">
                <div class="flex-1">
                    <p class="text-[#333333] dark:text-white text-base font-normal leading-normal">경력</p>
                    <p class="text-[#666666] dark:text-gray-400 text-sm leading-tight">회사명, 직책, 기간 등</p>
                </div>
                <label
                    class="relative flex h-[31px] w-[51px] cursor-pointer items-center rounded-full border-none bg-[#CCCCCC] p-0.5 has-[:checked]:justify-end has-[:checked]:bg-primary">
                    <div class="h-full w-[27px] rounded-full bg-white transition-transform"></div>
                    <input id="careerCheckbox" checked="" class="invisible absolute" type="checkbox" />
                </label>
            </div>
            <div class="flex items-center justify-between px-4 py-3 min-h-[56px]">
                <div class="flex-1">
                    <p class="text-[#333333] dark:text-white text-base font-normal leading-normal">학력</p>
                    <p class="text-[#666666] dark:text-gray-400 text-sm leading-tight">학교명, 전공, 졸업 연도 등</p>
                </div>
                <label
                    class="relative flex h-[31px] w-[51px] cursor-pointer items-center rounded-full border-none bg-[#CCCCCC] p-0.5 has-[:checked]:justify-end has-[:checked]:bg-primary">
                    <div class="h-full w-[27px] rounded-full bg-white transition-transform"></div>
                    <input id="educationCheckbox" checked="" class="invisible absolute" type="checkbox" />
                </label>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/supabase.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/toast.js"></script>
    <script src="js/page-transition.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const session = await requireAuth();
            if (!session) return;

            const user = await getCurrentUser();
            const client = initSupabase();

            // 뒤로가기
            document.querySelector('.flex.size-12.shrink-0').addEventListener('click', () => window.history.back());

            try {
                // 사용자 프로필 정보 가져오기 (기수 정보 필요)
                const { data: profile, error: profileError } = await client
                    .from('profiles')
                    .select('batch')
                    .eq('id', user.id)
                    .single();

                if (profileError) throw profileError;

                // 개인정보 공개 설정 로드
                let { data: settings, error: settingsError } = await client
                    .from('privacy_settings')
                    .select('*')
                    .eq('profile_id', user.id)
                    .single();

                // 없으면 기본값으로 생성 (다른 기수에게도 공개 = true)
                if (settingsError && settingsError.code === 'PGRST116') {
                    const { data, error: insertError } = await client
                        .from('privacy_settings')
                        .insert({
                            profile_id: user.id,
                            show_phone: true,  // 다른 기수에게도 공개
                            show_email: true,  // 다른 기수에게도 공개
                            show_career: true,
                            show_education: true
                        })
                        .select()
                        .single();
                    
                    if (insertError) throw insertError;
                    settings = data;
                } else if (settingsError) {
                    throw settingsError;
                }

                // 체크박스 찾기 (ID로 직접 찾기)
                const phoneCheckbox = document.getElementById('phoneCheckbox');
                const emailCheckbox = document.getElementById('emailCheckbox');
                const careerCheckbox = document.getElementById('careerCheckbox');
                const educationCheckbox = document.getElementById('educationCheckbox');

                // 토글 상태 설정
                // show_phone/show_email은 "다른 기수에게도 공개" 여부를 의미
                phoneCheckbox.checked = settings.show_phone !== false;
                emailCheckbox.checked = settings.show_email !== false;
                careerCheckbox.checked = settings.show_career !== false;
                educationCheckbox.checked = settings.show_education !== false;

                // 저장 버튼
                const saveBtn = document.querySelector('.text-primary');
                saveBtn.style.cursor = 'pointer';
                saveBtn.addEventListener('click', async () => {
                    try {
                        const { error: updateError } = await client
                            .from('privacy_settings')
                            .update({
                                show_phone: phoneCheckbox.checked,
                                show_email: emailCheckbox.checked,
                                show_career: careerCheckbox.checked,
                                show_education: educationCheckbox.checked,
                                updated_at: new Date().toISOString()
                            })
                            .eq('profile_id', user.id);

                        if (updateError) throw updateError;

                        showSuccess('개인정보 공개 설정이 저장되었습니다!');
                        setTimeout(() => {
                            smoothNavigate('my_profile.html');
                        }, 1000);
                    } catch (error) {
                        showError('설정 저장에 실패했습니다.');
                    }
                });

            } catch (error) {
                showError('설정을 불러오는데 실패했습니다.');
            }
        });
    </script>

</body>

</html>