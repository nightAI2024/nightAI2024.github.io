<!DOCTYPE html>

<html class="light" lang="ko">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>공지사항 상세</title>
        <meta name="description" content="CAIO 원우회 회원의 상세 프로필, 경력, 연락처 정보를 확인하세요.">
    <meta property="og:type" content="website">
    <meta property="og:title" content="CAIO 원우회 네트워크">
    <meta property="og:description" content="CAIO 원우회 회원의 상세 프로필, 경력, 연락처 정보를 확인하세요.">
    <meta name="twitter:title" content="CAIO 원우회 네트워크">
    <meta name="twitter:description" content="CAIO 원우회 회원의 상세 프로필, 경력, 연락처 정보를 확인하세요.">
    <meta property="og:image" content="https://raw.githubusercontent.com/nightAI2024/nightAI2024.github.io/refs/heads/main/img/og_image_c.png">
    <meta name="twitter:image" content="https://raw.githubusercontent.com/nightAI2024/nightAI2024.github.io/refs/heads/main/img/og_image_c.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap"
        rel="stylesheet" />
    <style>
        .material-symbols-outlined {
            font-variation-settings:
                'FILL' 0,
                'wght' 400,
                'GRAD' 0,
                'opsz' 24
        }
    </style>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                        "foreground-light": "#ffffff",
                        "foreground-dark": "#1a2836",
                        "text-primary-light": "#111418",
                        "text-primary-dark": "#f0f2f4",
                        "text-secondary-light": "#617589",
                        "text-secondary-dark": "#a0b3c6",
                        "border-light": "#e3e8ed",
                        "border-dark": "#2c3e50"
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
                },
            },
        }
    </script>
    <style>
        body {
            min-height: max(884px, 100dvh);
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
    </style>
</head>

<body class="font-display bg-background-light dark:bg-background-dark">
    <div class="relative flex min-h-screen w-full flex-col group/design-root overflow-x-hidden">
        <!-- TopAppBar -->
        <header
            class="sticky top-0 z-10 flex h-14 items-center border-b border-slate-200/80 bg-background-light/80 dark:border-slate-800/80 dark:bg-background-dark/80 backdrop-blur-sm px-4">
            <button id="backBtn"
                class="flex size-10 shrink-0 items-center justify-center rounded-full text-slate-700 dark:text-slate-300 cursor-pointer">
                <span class="material-symbols-outlined text-2xl">arrow_back</span>
            </button>
            <h1 class="text-lg font-bold text-slate-900 dark:text-slate-100 flex-1 text-center">공지사항</h1>
            <button id="menuBtn" class="flex size-10 shrink-0 items-center justify-center rounded-full text-slate-700 dark:text-slate-300 cursor-pointer" style="display: none;">
                <span class="material-symbols-outlined text-2xl">more_vert</span>
            </button>
        </header>
        <main class="flex-1 pb-20">
            <div class="p-5">
                <!-- HeadlineText -->
                <h2 id="noticeTitle" class="text-2xl font-bold leading-tight tracking-tight text-slate-900 dark:text-slate-100"></h2>
                <!-- MetaText -->
                <p id="noticeMeta" class="mt-2 text-sm font-normal text-slate-500 dark:text-slate-400"></p>
            </div>
            <hr class="border-t border-slate-200 dark:border-slate-800 mx-5" />
            <!-- BodyText -->
            <div id="noticeContent" class="p-5 text-base font-normal leading-relaxed text-slate-700 dark:text-slate-300 space-y-4">
                <p class="text-center text-slate-500">로딩 중...</p>
            </div>
            <div id="linkSection" class="px-5 pt-4" style="display: none;">
                <h3 class="text-lg font-bold leading-tight tracking-tight text-slate-900 dark:text-slate-100">관련 링크</h3>
                <div id="linkList" class="mt-3 space-y-2.5"></div>
            </div>
            <!-- Attachment Section -->
            <div id="attachmentSection" class="px-5 pt-4 pb-8" style="display: none;">
                <!-- SectionHeader -->
                <h3 class="text-lg font-bold leading-tight tracking-tight text-slate-900 dark:text-slate-100">첨부파일</h3>
                <!-- Attachment List -->
                <div id="attachmentList" class="mt-3 space-y-2.5">
                </div>
            </div>
        </main>
    </div>

    <!-- 하단 네비게이션 -->
    <nav class="fixed bottom-0 left-0 right-0 h-20 bg-foreground-light dark:bg-foreground-dark border-t border-border-light dark:border-border-dark flex justify-around items-center px-2 z-30">
        <a class="flex flex-col items-center justify-center gap-1 w-full text-gray-500 dark:text-gray-400" href="main">
            <span class="material-symbols-outlined !text-3xl">home</span>
            <span class="text-xs font-medium">홈</span>
        </a>
        <a class="flex flex-col items-center justify-center gap-1 w-full text-gray-500 dark:text-gray-400" href="contact">
            <span class="material-symbols-outlined !text-3xl">group</span>
            <span class="text-xs font-medium">명부</span>
        </a>
        <a class="flex flex-col items-center justify-center gap-1 w-full text-gray-500 dark:text-gray-400" href="community">
            <span class="material-symbols-outlined !text-3xl">chat</span>
            <span class="text-xs font-medium">커뮤니티</span>
        </a>
        <a class="flex flex-col items-center justify-center gap-1 w-full text-gray-500 dark:text-gray-400" href="my_profile">
            <span class="material-symbols-outlined !text-3xl">person</span>
            <span class="text-xs font-medium">마이페이지</span>
        </a>
    </nav>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/supabase.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/admin.js"></script>
    <script src="js/notice.js"></script>
    <script src="js/toast.js"></script>
    <script src="js/page-transition.js"></script>

    <script>
        let noticeId = null;
        let noticeData = null;
        let currentUser = null;

        document.addEventListener('DOMContentLoaded', async () => {
            const session = await requireAuth();
            if (!session) return;

            currentUser = await getCurrentUser();
            noticeId = new URLSearchParams(window.location.search).get('id');
            
            if (!noticeId) {
                showError('공지사항 ID가 없습니다.');
                setTimeout(() => {
                    smoothNavigate('notice_list.html');
                }, 1000);
                return;
            }

            const client = initSupabase();

            // 뒤로 가기
            document.getElementById('backBtn').addEventListener('click', () => window.history.back());

            // 관리자 메뉴 버튼
            const canWrite = await canWriteNotice();
            const menuBtn = document.getElementById('menuBtn');
            if (canWrite) {
                menuBtn.style.display = 'flex';
                menuBtn.addEventListener('click', showNoticeMenu);
            }

            await loadNotice();
        });

        async function loadNotice() {
            try {
                const client = initSupabase();

                // 공지사항 로드
                const { data: notice, error } = await client
                    .from('notices')
                    .select('*, profiles:author_id(*), notice_attachments(*)')
                    .eq('id', noticeId)
                    .single();

                if (error) throw error;

                noticeData = notice;

                // 조회수 증가
                await client.from('notices').update({
                    view_count: (notice.view_count || 0) + 1
                }).eq('id', noticeId);

                // 화면에 표시
                document.getElementById('noticeTitle').textContent = notice.title || '';
                const authorName = notice.profiles?.name || '관리자';
                const authorBatch = notice.profiles?.batch ? `${notice.profiles.batch}기` : '';
                document.getElementById('noticeMeta').textContent =
                    `작성자: ${authorName}${authorBatch ? ` · ${authorBatch}` : ''} | 작성일: ${formatDate(notice.created_at)} | 조회수: ${(notice.view_count || 0) + 1}`;
                
                document.getElementById('noticeContent').innerHTML =
                    `<div class="whitespace-pre-wrap">${escapeHtml(notice.content || '')}</div>`;

                const { data: noticeLinks, error: linksError } = await client
                    .from('notice_links')
                    .select('*')
                    .eq('notice_id', noticeId)
                    .order('order', { ascending: true });

                // 링크 처리
                const linkSection = document.getElementById('linkSection');
                const linkList = document.getElementById('linkList');
                if (noticeLinks && noticeLinks.length > 0) {
                    const linkItems = noticeLinks
                        .sort((a, b) => (a.order ?? 0) - (b.order ?? 0))
                        .map(link => {
                            const url = link.url || '#';
                            let subtitle = url;
                            try {
                                const parsed = new URL(url);
                                subtitle = parsed.hostname;
                            } catch (err) {
                                subtitle = url;
                            }
                            return `
                                <a class="flex items-center gap-3 rounded-lg border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 p-3 shadow-sm transition-colors hover:bg-slate-100 dark:hover:bg-slate-800/60" href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer">
                                    <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-md bg-blue-100 dark:bg-blue-900/40">
                                        <span class="material-symbols-outlined text-blue-600 dark:text-blue-400">link</span>
                                    </div>
                                    <div class="flex-1 overflow-hidden">
                                        <p class="truncate font-medium text-sm text-slate-800 dark:text-slate-200">${escapeHtml(link.title || url)}</p>
                                        <p class="text-xs text-slate-500 dark:text-slate-400 truncate">${escapeHtml(subtitle)}</p>
                                    </div>
                                    <span class="material-symbols-outlined text-slate-500 dark:text-slate-400">open_in_new</span>
                                </a>
                            `;
                        }).join('');

                    linkList.innerHTML = linkItems;
                    linkSection.style.display = 'block';
                } else {
                    linkSection.style.display = 'none';
                }

                // 첨부파일 처리
                const attachmentsSection = document.getElementById('attachmentSection');
                const attachmentList = document.getElementById('attachmentList');
                
                if (notice.notice_attachments && notice.notice_attachments.length > 0) {
                    attachmentsSection.style.display = 'block';
                    attachmentList.innerHTML = notice.notice_attachments.map(file => {
                        const fileExtension = file.file_name?.split('.').pop()?.toLowerCase() || '';
                        let iconColor = 'blue';
                        let iconName = 'description';
                        
                        if (fileExtension === 'pdf') {
                            iconColor = 'red';
                            iconName = 'picture_as_pdf';
                        } else if (['jpg', 'jpeg', 'png', 'gif'].includes(fileExtension)) {
                            iconColor = 'green';
                            iconName = 'image';
                        } else if (['zip', 'rar'].includes(fileExtension)) {
                            iconColor = 'yellow';
                            iconName = 'folder_zip';
                        }

                        return `
                            <a class="flex items-center gap-3 rounded-lg border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 p-3 shadow-sm transition-colors hover:bg-slate-100 dark:hover:bg-slate-800/60"
                                href="${escapeHtml(file.file_url || '#')}" target="_blank">
                                <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-md bg-${iconColor}-100 dark:bg-${iconColor}-900/40">
                                    <span class="material-symbols-outlined text-${iconColor}-600 dark:text-${iconColor}-400">${iconName}</span>
                                </div>
                                <div class="flex-1 overflow-hidden">
                                    <p class="truncate font-medium text-sm text-slate-800 dark:text-slate-200">${escapeHtml(file.file_name || '파일')}</p>
                                    <p class="text-xs text-slate-500 dark:text-slate-400">${formatFileSize(file.file_size || 0)}</p>
                                </div>
                                <span class="material-symbols-outlined text-slate-500 dark:text-slate-400">download</span>
                            </a>
                        `;
                    }).join('');
                } else {
                    attachmentsSection.style.display = 'none';
                }

            } catch (error) {
                showError('공지사항을 불러오는데 실패했습니다.');
                document.querySelector('main').innerHTML = '<p class="text-center text-red-500 py-8">공지사항을 불러올 수 없습니다.</p>';
            }
        }

        function showNoticeMenu() {
            const menuHtml = `
                <div id="noticeMenuOverlay" class="fixed inset-0 bg-black/50 z-50 flex items-end" style="animation: fadeIn 0.2s ease;">
                    <div class="w-full bg-white dark:bg-gray-800 rounded-t-2xl p-4" style="animation: slideUp 0.3s ease;">
                        <button id="editNoticeBtn" class="w-full py-4 text-left text-base font-medium text-text-primary-light dark:text-text-primary-dark hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg px-4">
                            <span class="material-symbols-outlined align-middle mr-2">edit</span>
                            수정하기
                        </button>
                        <button id="deleteNoticeBtn" class="w-full py-4 text-left text-base font-medium text-red-600 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg px-4">
                            <span class="material-symbols-outlined align-middle mr-2">delete</span>
                            삭제하기
                        </button>
                        <button id="cancelMenuBtn" class="w-full py-4 text-center text-base font-medium text-text-secondary-light dark:text-text-secondary-dark hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg mt-2">
                            취소
                        </button>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', menuHtml);

            document.getElementById('editNoticeBtn').addEventListener('click', editNotice);
            document.getElementById('deleteNoticeBtn').addEventListener('click', deleteNoticeHandler);
            document.getElementById('cancelMenuBtn').addEventListener('click', closeNoticeMenu);
            document.getElementById('noticeMenuOverlay').addEventListener('click', (e) => {
                if (e.target.id === 'noticeMenuOverlay') closeNoticeMenu();
            });
        }

        function closeNoticeMenu() {
            const menu = document.getElementById('noticeMenuOverlay');
            if (menu) menu.remove();
        }

        function editNotice() {
            closeNoticeMenu();
            smoothNavigate(`notice_write.html?edit=${noticeId}`, 300);
        }

        async function deleteNoticeHandler() {
            closeNoticeMenu();
            showConfirm('정말 이 공지사항을 삭제하시겠습니까?', async () => {
                try {
                    await deleteNotice(noticeId);
                    showSuccess('공지사항이 삭제되었습니다.');
                    setTimeout(() => {
                        smoothNavigate('notice_list.html');
                    }, 1000);
                } catch (error) {
                    showError('공지사항 삭제에 실패했습니다.');
                }
            });
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }
    </script>
</body>

</html>