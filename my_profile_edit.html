<!DOCTYPE html>
<html class="light" lang="ko">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Edit Profile</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&amp;display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                    },
                    fontFamily: {
                        "display": ["Inter"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style>
        body {
            min-height: max(884px, 100dvh);
        }
    </style>
</head>

<body class="font-display">
    <div class="relative flex h-auto min-h-screen w-full flex-col bg-background-light dark:bg-background-dark group/design-root overflow-x-hidden text-[#101922] dark:text-gray-200">
        <div class="sticky top-0 z-10 flex items-center justify-between border-b border-gray-200 dark:border-gray-700 bg-background-light dark:bg-background-dark p-4 pb-3">
            <div class="flex size-10 shrink-0 items-center justify-start">
                <button id="backBtn" class="flex items-center justify-center">
                    <span class="material-symbols-outlined text-2xl text-[#101922] dark:text-gray-200">arrow_back</span>
                </button>
            </div>
            <h1 class="text-lg font-bold leading-tight tracking-[-0.015em] text-[#101922] dark:text-white">프로필 수정</h1>
            <div class="flex size-10 items-center justify-end">
                <button id="saveBtn" class="text-base font-bold text-primary">저장</button>
            </div>
        </div>
        <div class="flex flex-col p-4">
            <div class="flex flex-col items-center gap-4 py-4">
                <div class="relative">
                    <div id="profileImage" class="bg-center bg-no-repeat aspect-square bg-cover rounded-full min-h-32 w-32 bg-gray-300"
                        style='background-image: url("https://via.placeholder.com/150");'>
                    </div>
                    <input type="file" id="profileImageInput" accept="image/*" class="hidden" />
                    <button id="editImageBtn" type="button" class="absolute bottom-0 right-0 flex h-10 w-10 items-center justify-center rounded-full bg-primary text-white shadow-lg hover:bg-primary/90 transition-colors">
                        <span class="material-symbols-outlined text-xl">photo_camera</span>
                    </button>
                    <button id="removeImageBtn" type="button" class="hidden absolute bottom-0 left-0 flex h-10 w-10 items-center justify-center rounded-full bg-red-500 text-white shadow-lg hover:bg-red-600 transition-colors">
                        <span class="material-symbols-outlined text-xl">close</span>
                    </button>
                </div>
                <p class="text-xs text-gray-500 dark:text-gray-400">JPG, PNG, GIF, WEBP (최대 3MB)</p>
            </div>
            <div class="flex flex-col gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" for="introduction">소개</label>
                    <textarea class="block w-full rounded-lg border-gray-300 bg-white dark:bg-gray-800 dark:border-gray-600 dark:text-white shadow-sm focus:border-primary focus:ring-primary text-base" id="introduction" rows="4"></textarea>
                </div>
                <div class="flex w-full flex-col gap-4 rounded-xl bg-white dark:bg-gray-800 p-4">
                    <h4 class="text-base font-bold leading-tight text-[#101922] dark:text-white">연락처 정보</h4>
                    <div class="flex flex-col gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" for="phone">휴대폰</label>
                            <input class="block w-full rounded-lg border-gray-300 bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white shadow-sm focus:border-primary focus:ring-primary text-sm" id="phone" type="tel" value="" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" for="email">이메일</label>
                            <input class="block w-full rounded-lg border-gray-300 bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white shadow-sm focus:border-primary focus:ring-primary text-sm" id="email" type="email" value="" />
                        </div>
                    </div>
                </div>
                <div class="flex w-full flex-col gap-4 rounded-xl bg-white dark:bg-gray-800 p-4">
                    <div class="flex items-center justify-between">
                        <h4 class="text-base font-bold leading-tight text-[#101922] dark:text-white">경력 정보</h4>
                        <p class="text-xs text-gray-500 dark:text-gray-400">맨 위 경력이 프로필에 노출됩니다</p>
                    </div>
                    <div id="careerContainer" class="flex flex-col gap-4"></div>
                    <button id="addCareerBtn" class="flex w-full items-center justify-center gap-2 rounded-lg border border-primary py-2 text-sm font-bold text-primary">
                        <span class="material-symbols-outlined text-lg">add</span>
                        <span>경력 추가</span>
                    </button>
                </div>
                <div class="flex w-full flex-col gap-4 rounded-xl bg-white dark:bg-gray-800 p-4">
                    <h4 class="text-base font-bold leading-tight text-[#101922] dark:text-white">학력 정보</h4>
                    <div id="educationContainer" class="flex flex-col gap-4"></div>
                    <button id="addEducationBtn" class="flex w-full items-center justify-center gap-2 rounded-lg border border-primary py-2 text-sm font-bold text-primary">
                        <span class="material-symbols-outlined text-lg">add</span>
                        <span>학력 추가</span>
                    </button>
                </div>
            </div>
            <div class="h-5"></div>
        </div>
    </div>
    
    <script src="js/config.js"></script>
    <script src="js/supabase.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/profile.js"></script>
    <script src="js/profile-utils.js"></script>
    <script src="js/toast.js"></script>
    <script src="js/page-transition.js"></script>

    <script>
        let careers = [];
        let educations = [];
        let deletedCareers = [];
        let deletedEducations = [];
        let uploadedImageUrl = undefined; // undefined: 변경 없음, null: 이미지 제거, URL: 새 이미지
        let currentProfile = null;

        document.addEventListener('DOMContentLoaded', async () => {
            const session = await requireAuth();
            if (!session) return;

            const user = await getCurrentUser();
            const client = initSupabase();

            // 뒤로가기
            document.getElementById('backBtn').addEventListener('click', () => window.history.back());

            // 프로필 이미지 업로드 버튼
            document.getElementById('editImageBtn').addEventListener('click', () => {
                document.getElementById('profileImageInput').click();
            });

            // 이미지 파일 선택 시
            document.getElementById('profileImageInput').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                try {
                    // 로딩 표시
                    const profileImageEl = document.getElementById('profileImage');
                    const originalContent = profileImageEl.innerHTML;
                    profileImageEl.innerHTML = '<div class="flex items-center justify-center h-full"><span class="text-white text-sm">업로드 중...</span></div>';

                    // 이미지 업로드
                    uploadedImageUrl = await uploadProfileImage(file, user.id);

                    // 미리보기 표시
                    profileImageEl.style.backgroundImage = `url('${uploadedImageUrl}')`;
                    profileImageEl.style.backgroundSize = 'cover';
                    profileImageEl.innerHTML = '';

                    // 취소 버튼 표시
                    document.getElementById('removeImageBtn').classList.remove('hidden');

                    showSuccess('이미지가 업로드되었습니다!');
                } catch (error) {
                    showError(error.message || '이미지 업로드에 실패했습니다.');
                    // 원래 상태로 복구
                    if (currentProfile) {
                        setProfileImage(document.getElementById('profileImage'), currentProfile);
                    }
                }
            });

            // 프로필 이미지 제거 버튼
            document.getElementById('removeImageBtn').addEventListener('click', () => {
                showConfirm('프로필 사진을 제거하시겠습니까?', () => {
                    // 업로드된 이미지 URL을 null로 설정 (저장 시 DB에서 제거)
                    uploadedImageUrl = null;
                    
                    // 기본 아바타로 설정
                    const profileImageEl = document.getElementById('profileImage');
                    setProfileImage(profileImageEl, { name: currentProfile?.name, profile_image_url: null });
                    
                    // 취소 버튼 숨기기
                    document.getElementById('removeImageBtn').classList.add('hidden');
                    
                    showInfo('프로필 사진이 제거되었습니다. 저장 버튼을 눌러 변경사항을 저장하세요.');
                });
            });

            try {
                // 프로필 로드
                const { data: profile, error: profileError } = await client
                    .from('profiles')
                    .select('*')
                    .eq('id', user.id)
                    .single();

                if (profileError) throw profileError;

                currentProfile = profile;

                // 폼에 기존 정보 채우기
                document.getElementById('introduction').value = profile.introduction || '';
                document.getElementById('phone').value = profile.phone || '';
                document.getElementById('email').value = profile.email || '';

                // 프로필 이미지 설정
                setProfileImage(document.getElementById('profileImage'), profile);
                
                // 프로필 이미지가 있으면 제거 버튼 표시
                if (profile.profile_image_url) {
                    document.getElementById('removeImageBtn').classList.remove('hidden');
                }

                // 경력 로드
                const { data: careersData, error: careersError } = await client
                    .from('careers')
                    .select('*')
                    .eq('profile_id', user.id)
                    .order('order', { ascending: true });

                if (careersError) throw careersError;
                careers = careersData || [];
                renderCareers();

                // 학력 로드
                const { data: educationsData, error: educationsError } = await client
                    .from('educations')
                    .select('*')
                    .eq('profile_id', user.id)
                    .order('order', { ascending: true });

                if (educationsError) throw educationsError;
                educations = educationsData || [];
                renderEducations();

                // 경력 추가 버튼
                document.getElementById('addCareerBtn').addEventListener('click', () => {
                    careers.push({
                        id: null,
                        profile_id: user.id,
                        company: '',
                        position: '',
                        start_year: '',
                        end_year: '',
                        order: careers.length
                    });
                    renderCareers();
                });

                // 학력 추가 버튼
                document.getElementById('addEducationBtn').addEventListener('click', () => {
                    educations.push({
                        id: null,
                        profile_id: user.id,
                        school: '',
                        degree: '',
                        start_year: '',
                        end_year: '',
                        order: educations.length
                    });
                    renderEducations();
                });

                // 저장 버튼
                document.getElementById('saveBtn').addEventListener('click', async () => {
                    try {
                        const introduction = document.getElementById('introduction').value.trim();
                        const phone = document.getElementById('phone').value.trim();
                        const email = document.getElementById('email').value.trim();

                        setLoading('saveBtn', true);

                        // 프로필 업데이트 (이미지 URL 포함)
                        const updateData = {
                            introduction: introduction,
                            phone: phone,
                            email: email,
                            updated_at: new Date().toISOString()
                        };

                        // 프로필 이미지 업데이트
                        // uploadedImageUrl이 null이면 프로필 이미지 제거
                        // undefined면 변경 없음 (기존 이미지 유지)
                        if (uploadedImageUrl !== undefined) {
                            updateData.profile_image_url = uploadedImageUrl;
                        }

                        const { error: updateError } = await client
                            .from('profiles')
                            .update(updateData)
                            .eq('id', user.id);

                        if (updateError) throw updateError;

                        // 삭제된 경력 삭제
                        for (const id of deletedCareers) {
                            await client.from('careers').delete().eq('id', id);
                        }

                        // 경력 업데이트/추가
                        for (let i = 0; i < careers.length; i++) {
                            const career = careers[i];
                            career.order = i;

                            if (career.id) {
                                // 기존 경력 업데이트
                                const { error } = await client.from('careers').update({
                                    company: career.company,
                                    position: career.position,
                                    start_year: career.start_year,
                                    end_year: career.end_year,
                                    order: career.order
                                }).eq('id', career.id);
                                
                                if (error) {
                                    throw error;
                                }
                            } else {
                                // 새 경력 추가
                                if (career.company || career.position) {
                                    const { data, error } = await client.from('careers').insert({
                                        profile_id: user.id,
                                        company: career.company,
                                        position: career.position,
                                        start_year: career.start_year,
                                        end_year: career.end_year,
                                        order: career.order
                                    });
                                    
                                    if (error) {
                                        throw error;
                                    }
                                }
                            }
                        }

                        // 삭제된 학력 삭제
                        for (const id of deletedEducations) {
                            await client.from('educations').delete().eq('id', id);
                        }

                        // 학력 업데이트/추가
                        for (let i = 0; i < educations.length; i++) {
                            const education = educations[i];
                            education.order = i;

                            if (education.id) {
                                // 기존 학력 업데이트
                                const { error } = await client.from('educations').update({
                                    school: education.school,
                                    major: education.degree, // "전공 및 학위" 입력값을 major에 저장
                                    degree: education.degree,
                                    start_year: education.start_year,
                                    end_year: education.end_year,
                                    order: education.order
                                }).eq('id', education.id);
                                
                                if (error) {
                                    throw error;
                                }
                            } else {
                                // 새 학력 추가
                                if (education.school || education.degree) {
                                    const { data, error } = await client.from('educations').insert({
                                        profile_id: user.id,
                                        school: education.school,
                                        major: education.degree, // "전공 및 학위" 입력값을 major에 저장
                                        degree: education.degree,
                                        start_year: education.start_year,
                                        end_year: education.end_year,
                                        order: education.order
                                    });
                                    
                                    if (error) {
                                        throw error;
                                    }
                                }
                            }
                        }

                        showSuccess('프로필이 성공적으로 수정되었습니다!');
                        setTimeout(() => {
                            smoothNavigate('my_profile.html');
                        }, 1000);

                    } catch (error) {
                        showError('프로필 수정에 실패했습니다.');
                        setLoading('saveBtn', false);
                    }
                });

            } catch (error) {
                showError('프로필을 불러오는데 실패했습니다.');
            }
        });

        function renderCareers() {
            const container = document.getElementById('careerContainer');
            container.innerHTML = careers.map((career, index) => {
                const isFirst = index === 0;
                return `
                <div class="rounded-lg border p-3 transition-all ${isFirst ? 'border-primary bg-primary/5 dark:bg-primary/10 border-2' : 'border-gray-200 dark:border-gray-700'}" data-index="${index}">
                    ${isFirst ? '<div class="flex items-center gap-1 mb-2 text-xs font-semibold text-primary"><span class="material-symbols-outlined text-sm">star</span><span>프로필에 노출되는 경력</span></div>' : ''}
                    <div class="flex items-start justify-between gap-2">
                        <div class="flex flex-grow flex-col gap-3 pr-2">
                            <input class="career-company block w-full rounded-md border-gray-300 bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white shadow-sm focus:border-primary focus:ring-primary text-sm"
                                placeholder="회사명" type="text" value="${escapeHtml(career.company || '')}" />
                            <input class="career-position block w-full rounded-md border-gray-300 bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white shadow-sm focus:border-primary focus:ring-primary text-sm"
                                placeholder="직책" type="text" value="${escapeHtml(career.position || '')}" />
                            <div class="flex items-center gap-2">
                                <input class="career-start block w-full rounded-md border-gray-300 bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white shadow-sm focus:border-primary focus:ring-primary text-sm"
                                    placeholder="시작 연도" type="text" value="${escapeHtml(career.start_year || '')}" />
                                <span class="text-gray-400">-</span>
                                <input class="career-end block w-full rounded-md border-gray-300 bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white shadow-sm focus:border-primary focus:ring-primary text-sm"
                                    placeholder="종료 연도 (현재)" type="text" value="${escapeHtml(career.end_year || '')}" />
                            </div>
                        </div>
                        <div class="flex flex-col shrink-0 gap-1">
                            <div class="flex flex-col gap-1">
                                <button class="move-career-up-btn p-1 ${index === 0 ? 'opacity-30 cursor-not-allowed' : 'hover:bg-gray-100 dark:hover:bg-gray-700'}" 
                                    data-index="${index}" 
                                    ${index === 0 ? 'disabled' : ''}>
                                    <span class="material-symbols-outlined text-lg text-gray-600 dark:text-gray-400">arrow_upward</span>
                                </button>
                                <button class="move-career-down-btn p-1 ${index === careers.length - 1 ? 'opacity-30 cursor-not-allowed' : 'hover:bg-gray-100 dark:hover:bg-gray-700'}" 
                                    data-index="${index}" 
                                    ${index === careers.length - 1 ? 'disabled' : ''}>
                                    <span class="material-symbols-outlined text-lg text-gray-600 dark:text-gray-400">arrow_downward</span>
                                </button>
                            </div>
                            <button class="delete-career-btn p-1 mt-1 hover:bg-gray-100 dark:hover:bg-gray-700" data-index="${index}">
                                <span class="material-symbols-outlined text-lg text-red-500 hover:text-red-700">delete</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            }).join('');

            // 이벤트 리스너 추가
            careers.forEach((career, index) => {
                const careerEl = container.querySelector(`[data-index="${index}"]`);
                careerEl.querySelector('.career-company').addEventListener('input', (e) => {
                    careers[index].company = e.target.value;
                });
                careerEl.querySelector('.career-position').addEventListener('input', (e) => {
                    careers[index].position = e.target.value;
                });
                careerEl.querySelector('.career-start').addEventListener('input', (e) => {
                    careers[index].start_year = e.target.value;
                });
                careerEl.querySelector('.career-end').addEventListener('input', (e) => {
                    careers[index].end_year = e.target.value;
                });
            });

            // 위로 이동 버튼
            container.querySelectorAll('.move-career-up-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const index = parseInt(btn.dataset.index);
                    if (index > 0) {
                        // 배열에서 위치 교환
                        [careers[index], careers[index - 1]] = [careers[index - 1], careers[index]];
                        renderCareers();
                    }
                });
            });

            // 아래로 이동 버튼
            container.querySelectorAll('.move-career-down-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const index = parseInt(btn.dataset.index);
                    if (index < careers.length - 1) {
                        // 배열에서 위치 교환
                        [careers[index], careers[index + 1]] = [careers[index + 1], careers[index]];
                        renderCareers();
                    }
                });
            });

            // 삭제 버튼
            container.querySelectorAll('.delete-career-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const index = parseInt(btn.dataset.index);
                    if (careers[index].id) {
                        deletedCareers.push(careers[index].id);
                    }
                    careers.splice(index, 1);
                    renderCareers();
                });
            });
        }

        function renderEducations() {
            const container = document.getElementById('educationContainer');
            container.innerHTML = educations.map((education, index) => `
                <div class="rounded-lg border border-gray-200 dark:border-gray-700 p-3" data-index="${index}">
                    <div class="flex items-start justify-between">
                        <div class="flex flex-grow flex-col gap-3 pr-2">
                            <input class="education-school block w-full rounded-md border-gray-300 bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white shadow-sm focus:border-primary focus:ring-primary text-sm"
                                placeholder="학교명" type="text" value="${escapeHtml(education.school || '')}" />
                            <input class="education-degree block w-full rounded-md border-gray-300 bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white shadow-sm focus:border-primary focus:ring-primary text-sm"
                                placeholder="전공 및 학위" type="text" value="${escapeHtml(education.major || education.degree || '')}" />
                            <div class="flex items-center gap-2">
                                <input class="education-start block w-full rounded-md border-gray-300 bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white shadow-sm focus:border-primary focus:ring-primary text-sm"
                                    placeholder="입학 연도" type="text" value="${escapeHtml(education.start_year || '')}" />
                                <span class="text-gray-400">-</span>
                                <input class="education-end block w-full rounded-md border-gray-300 bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white shadow-sm focus:border-primary focus:ring-primary text-sm"
                                    placeholder="졸업 연도" type="text" value="${escapeHtml(education.end_year || '')}" />
                            </div>
                        </div>
                        <div class="flex shrink-0 gap-2 pl-2">
                            <button class="delete-education-btn mt-1" data-index="${index}">
                                <span class="material-symbols-outlined text-lg text-red-500 hover:text-red-700">delete</span>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');

            // 이벤트 리스너 추가
            educations.forEach((education, index) => {
                const educationEl = container.querySelector(`[data-index="${index}"]`);
                educationEl.querySelector('.education-school').addEventListener('input', (e) => {
                    educations[index].school = e.target.value;
                });
                educationEl.querySelector('.education-degree').addEventListener('input', (e) => {
                    educations[index].degree = e.target.value;
                });
                educationEl.querySelector('.education-start').addEventListener('input', (e) => {
                    educations[index].start_year = e.target.value;
                });
                educationEl.querySelector('.education-end').addEventListener('input', (e) => {
                    educations[index].end_year = e.target.value;
                });
            });

            // 삭제 버튼
            container.querySelectorAll('.delete-education-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const index = parseInt(btn.dataset.index);
                    if (educations[index].id) {
                        deletedEducations.push(educations[index].id);
                    }
                    educations.splice(index, 1);
                    renderEducations();
                });
            });
        }
    </script>
</body>

</html>
