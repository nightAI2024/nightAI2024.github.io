<!DOCTYPE html>

<html class="light" lang="ko">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>CAIO 원우회 - 비밀번호 재설정</title>
        <meta name="description" content="CAIO 원우회 회원의 상세 프로필, 경력, 연락처 정보를 확인하세요.">
    <meta property="og:type" content="website">
    <meta property="og:title" content="CAIO 원우회 네트워크">
    <meta property="og:description" content="CAIO 원우회 회원의 상세 프로필, 경력, 연락처 정보를 확인하세요.">
    <meta name="twitter:title" content="CAIO 원우회 네트워크">
    <meta name="twitter:description" content="CAIO 원우회 회원의 상세 프로필, 경력, 연락처 정보를 확인하세요.">
    <meta property="og:image" content="https://raw.githubusercontent.com/nightAI2024/nightAI2024.github.io/refs/heads/main/img/og_image_c.png">
    <meta name="twitter:image" content="https://raw.githubusercontent.com/nightAI2024/nightAI2024.github.io/refs/heads/main/img/og_image_c.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&amp;family=Noto+Sans+KR:wght@400;500;700&amp;display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <!-- Supabase JavaScript Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>tailwind.config = { darkMode: "class", theme: { extend: { colors: { primary: "#137fec", "background-light": "#f6f7f8", "background-dark": "#101922" }, fontFamily: { display: "Inter" }, borderRadius: { DEFAULT: "0.25rem", lg: "0.5rem", xl: "0.75rem", full: "9999px" } } } };</script>
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
            font-size: 24px;
        }
    </style>
    <style>
        body {
            min-height: max(884px, 100dvh);
        }
    </style>
</head>

<body class="font-display">
    <div
        class="relative flex h-auto min-h-screen w-full flex-col bg-background-light dark:bg-background-dark group/design-root overflow-x-hidden">
        <main class="flex w-full grow flex-col px-4 py-8">
            <div class="flex-grow flex flex-col justify-center">
                <!-- Logo -->
                <div class="flex justify-center items-center mb-8">
                    <div class="bg-primary text-white rounded-full h-16 w-16 flex items-center justify-center">
                        <span class="text-2xl font-bold tracking-tighter">CAIO</span>
                    </div>
                </div>
                <!-- Headline -->
                <div class="text-center">
                    <h1 class="text-[#111418] dark:text-white tracking-tight text-[32px] font-bold leading-tight pb-3">
                        비밀번호 재설정</h1>
                    <p class="text-[#617589] dark:text-gray-300 text-base font-normal leading-normal pb-8">새로운 비밀번호를 입력해주세요</p>
                </div>
                <!-- Reset Password Form -->
                <div class="w-full max-w-md mx-auto space-y-4">
                    <div class="flex w-full flex-wrap items-end">
                        <label class="flex flex-col min-w-40 flex-1">
                            <p class="text-[#111418] dark:text-gray-200 text-base font-medium leading-normal pb-2">새 비밀번호</p>
                            <div class="flex w-full flex-1 items-stretch">
                                <input id="newPassword"
                                    class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-l-lg text-[#111418] focus:outline-0 focus:ring-0 border border-[#dbe0e6] bg-white focus:border-primary h-14 placeholder:text-[#617589] p-[15px] border-r-0 pr-2 text-base font-normal leading-normal dark:bg-background-dark dark:border-gray-600 dark:text-white dark:focus:border-primary"
                                    placeholder="새 비밀번호를 입력하세요" type="password" value="" />
                                <div
                                    class="text-[#617589] dark:text-gray-400 flex border border-[#dbe0e6] bg-white items-center justify-center pr-[15px] rounded-r-lg border-l-0 dark:bg-background-dark dark:border-gray-600">
                                    <span class="material-symbols-outlined cursor-pointer" id="toggleNewPassword">visibility</span>
                                </div>
                            </div>
                        </label>
                    </div>
                    <div class="flex w-full flex-wrap items-end">
                        <label class="flex flex-col min-w-40 flex-1">
                            <p class="text-[#111418] dark:text-gray-200 text-base font-medium leading-normal pb-2">비밀번호 확인</p>
                            <div class="flex w-full flex-1 items-stretch">
                                <input id="confirmPassword"
                                    class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-l-lg text-[#111418] focus:outline-0 focus:ring-0 border border-[#dbe0e6] bg-white focus:border-primary h-14 placeholder:text-[#617589] p-[15px] border-r-0 pr-2 text-base font-normal leading-normal dark:bg-background-dark dark:border-gray-600 dark:text-white dark:focus:border-primary"
                                    placeholder="비밀번호를 다시 입력하세요" type="password" value="" />
                                <div
                                    class="text-[#617589] dark:text-gray-400 flex border border-[#dbe0e6] bg-white items-center justify-center pr-[15px] rounded-r-lg border-l-0 dark:bg-background-dark dark:border-gray-600">
                                    <span class="material-symbols-outlined cursor-pointer" id="toggleConfirmPassword">visibility</span>
                                </div>
                            </div>
                        </label>
                    </div>
                    <!-- Password Requirements -->
                    <div class="text-sm text-[#617589] dark:text-gray-400">
                        <p class="mb-1">비밀번호 요구사항:</p>
                        <ul class="list-disc list-inside space-y-1 text-xs">
                            <li>최소 6자 이상</li>
                            <li>영문, 숫자, 특수문자 조합 권장</li>
                        </ul>
                    </div>
                    <!-- Reset Button -->
                    <button id="resetPasswordBtn"
                        class="flex w-full items-center justify-center rounded-lg bg-primary h-14 px-6 text-base font-bold text-white shadow-sm hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 mt-6">
                        비밀번호 재설정
                    </button>
                    <!-- Back to Login -->
                    <div class="text-center pt-4">
                        <a class="text-sm font-medium text-primary hover:underline" href="login">로그인 페이지로 돌아가기</a>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- JavaScript 파일들 -->
    <script src="js/config.js"></script>
    <script src="js/supabase.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/toast.js"></script>
    <script src="js/page-transition.js"></script>
    
    <script>
        // 비밀번호 재설정 페이지 초기화
        document.addEventListener('DOMContentLoaded', async () => {
            const client = initSupabase();
            const resetPasswordBtn = document.getElementById('resetPasswordBtn');
            const newPasswordInput = document.getElementById('newPassword');
            const confirmPasswordInput = document.getElementById('confirmPassword');
            const toggleNewPassword = document.getElementById('toggleNewPassword');
            const toggleConfirmPassword = document.getElementById('toggleConfirmPassword');

            // URL에서 토큰 확인 (쿼리 파라미터 또는 해시)
            let accessToken = null;
            let refreshToken = null;
            let type = null;

            // 방법 1: 쿼리 파라미터에서 확인
            const urlParams = new URLSearchParams(window.location.search);
            accessToken = urlParams.get('access_token');
            refreshToken = urlParams.get('refresh_token');
            type = urlParams.get('type');

            // 방법 2: 해시에서 확인 (Supabase가 해시로 보낼 수도 있음)
            if (!accessToken && window.location.hash) {
                const hashParams = new URLSearchParams(window.location.hash.substring(1));
                accessToken = hashParams.get('access_token') || accessToken;
                refreshToken = hashParams.get('refresh_token') || refreshToken;
                type = hashParams.get('type') || type;
            }

            // 토큰이 없거나 type이 recovery가 아니면 에러
            if (!accessToken || type !== 'recovery') {
                showError('유효하지 않은 링크입니다. 비밀번호 재설정 이메일의 링크를 사용해주세요.');
                
                setTimeout(() => {
                    smoothNavigate('login');
                }, 5000);
                return;
            }

            // 세션 복원
            try {
                const { data, error } = await client.auth.setSession({
                    access_token: accessToken,
                    refresh_token: refreshToken || ''
                });

                if (error) {
                    showError(`링크가 만료되었거나 유효하지 않습니다: ${error.message}`);
                    
                    setTimeout(() => {
                        smoothNavigate('login');
                    }, 5000);
                    return;
                }
            } catch (error) {
                showError(`링크 처리 중 오류가 발생했습니다: ${error.message}`);
                setTimeout(() => {
                    smoothNavigate('login');
                }, 5000);
                return;
            }

            // 비밀번호 표시/숨기기 토글
            toggleNewPassword.addEventListener('click', () => {
                const type = newPasswordInput.type === 'password' ? 'text' : 'password';
                newPasswordInput.type = type;
                toggleNewPassword.textContent = type === 'password' ? 'visibility' : 'visibility_off';
            });

            toggleConfirmPassword.addEventListener('click', () => {
                const type = confirmPasswordInput.type === 'password' ? 'text' : 'password';
                confirmPasswordInput.type = type;
                toggleConfirmPassword.textContent = type === 'password' ? 'visibility' : 'visibility_off';
            });

            // Enter 키로 재설정
            confirmPasswordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    resetPasswordBtn.click();
                }
            });

            // 비밀번호 재설정
            resetPasswordBtn.addEventListener('click', async () => {
                const newPassword = newPasswordInput.value;
                const confirmPassword = confirmPasswordInput.value;

                // 입력 검증
                if (!newPassword || !confirmPassword) {
                    showError('비밀번호를 입력하세요.');
                    return;
                }

                if (newPassword.length < 6) {
                    showError('비밀번호는 최소 6자 이상이어야 합니다.');
                    return;
                }

                if (newPassword !== confirmPassword) {
                    showError('비밀번호가 일치하지 않습니다.');
                    return;
                }

                setLoading('resetPasswordBtn', true);
                resetPasswordBtn.textContent = '재설정 중...';

                try {
                    await updatePassword(newPassword);
                    showSuccess('비밀번호가 성공적으로 변경되었습니다. 로그인 페이지로 이동합니다.');
                    setTimeout(() => {
                        smoothNavigate('login');
                    }, 2000);
                } catch (error) {
                    showError(error.message || '비밀번호 재설정에 실패했습니다. 다시 시도해주세요.');
                } finally {
                    setLoading('resetPasswordBtn', false);
                    resetPasswordBtn.textContent = '비밀번호 재설정';
                }
            });
        });
    </script>
</body>

</html>

