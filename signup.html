<!DOCTYPE html>
<html class="light" lang="ko">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>CAIO 원우회 - 회원가입</title>
        <meta name="description" content="CAIO 원우회 회원의 상세 프로필, 경력, 연락처 정보를 확인하세요.">
    <meta property="og:type" content="website">
    <meta property="og:title" content="CAIO 원우회 네트워크">
    <meta property="og:description" content="CAIO 원우회 회원의 상세 프로필, 경력, 연락처 정보를 확인하세요.">
    <meta name="twitter:title" content="CAIO 원우회 네트워크">
    <meta name="twitter:description" content="CAIO 원우회 회원의 상세 프로필, 경력, 연락처 정보를 확인하세요.">
    <meta property="og:image" content="https://raw.githubusercontent.com/nightAI2024/nightAI2024.github.io/refs/heads/main/img/og_image_c.png">
    <meta name="twitter:image" content="https://raw.githubusercontent.com/nightAI2024/nightAI2024.github.io/refs/heads/main/img/og_image_c.png">
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&amp;family=Noto+Sans+KR:wght@400;500;700&amp;display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <!-- Supabase JavaScript Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                    },
                    fontFamily: {
                        "display": ["Inter", "Noto Sans KR", "sans-serif"]
                    },
                    borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
                },
            },
        }
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
            font-size: 24px;
        }
    </style>
    <style>
        body {
            min-height: max(884px, 100dvh);
        }
    </style>
    <style>
        body {
            min-height: max(884px, 100dvh);
        }
    </style>
</head>

<body class="font-display">
    <div
        class="relative flex h-auto min-h-screen w-full flex-col bg-background-light dark:bg-background-dark group/design-root overflow-x-hidden">
        <main class="flex w-full grow flex-col px-4 py-8">
            <div class="flex-grow flex flex-col justify-center">
                <div class="flex justify-center items-center mb-8">
                    <div class="bg-primary text-white rounded-xl h-16 w-16 flex items-center justify-center">
                        <span class="text-2xl font-bold tracking-tighter">CAIO</span>
                    </div>
                </div>
                <div class="text-center">
                    <h1 class="text-[#111418] dark:text-white tracking-tight text-[32px] font-bold leading-tight pb-3">
                        회원가입</h1>
                    <p class="text-[#617589] dark:text-gray-300 text-base font-normal leading-normal pb-8">등록된 기수 회원만 등록 할 수 있습니다</p>
                </div>
                <div class="w-full max-w-md mx-auto space-y-4" id="signup-step-1">
                    <div class="flex w-full flex-wrap items-end">
                        <label class="flex flex-col min-w-40 flex-1">
                            <p class="text-[#111418] dark:text-gray-200 text-base font-medium leading-normal pb-2">이름
                            </p>
                            <input id="name"
                                class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-[#111418] focus:outline-0 focus:ring-0 border border-[#dbe0e6] bg-white focus:border-primary h-14 placeholder:text-[#617589] p-[15px] text-base font-normal leading-normal dark:bg-background-dark dark:border-gray-600 dark:text-white dark:focus:border-primary"
                                placeholder="이름을 입력하세요" value="" />
                        </label>
                    </div>
                    <div class="flex w-full flex-wrap items-end">
                        <label class="flex flex-col min-w-40 flex-1">
                            <p class="text-[#111418] dark:text-gray-200 text-base font-medium leading-normal pb-2">생년월일
                            </p>
                            <input id="birthDate"
                                class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-[#111418] focus:outline-0 focus:ring-0 border border-[#dbe0e6] bg-white focus:border-primary h-14 placeholder:text-[#617589] p-[15px] text-base font-normal leading-normal dark:bg-background-dark dark:border-gray-600 dark:text-white dark:focus:border-primary"
                                placeholder="생년월일 8자리를 입력하세요 (예: 19900101)" value="" maxlength="8" />
                        </label>
                    </div>
                    <div class="flex w-full flex-wrap items-end">
                        <label class="flex flex-col min-w-40 flex-1">
                            <p class="text-[#111418] dark:text-gray-200 text-base font-medium leading-normal pb-2">휴대폰
                                번호</p>
                            <input id="phone"
                                class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-[#111418] focus:outline-0 focus:ring-0 border border-[#dbe0e6] bg-white focus:border-primary h-14 placeholder:text-[#617589] p-[15px] text-base font-normal leading-normal dark:bg-background-dark dark:border-gray-600 dark:text-white dark:focus:border-primary"
                                placeholder="'-' 없이 숫자만 입력" value="" maxlength="11" />
                        </label>
                    </div>
                    <button id="verifyBtn"
                        class="flex w-full items-center justify-center rounded-lg bg-primary h-14 px-6 text-base font-bold text-white shadow-sm hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 mt-6">
                        검증하기
                    </button>
                    <div class="text-center pt-4">
                        <p class="text-sm text-[#617589] dark:text-gray-400">이미 계정이 있으신가요? <a
                                class="font-bold text-primary hover:underline" href="login">로그인</a></p>
                    </div>
                </div>
                <div class="w-full max-w-md mx-auto space-y-4 hidden" id="signup-step-2">
                    <div class="flex w-full flex-wrap items-end">
                        <label class="flex flex-col min-w-40 flex-1">
                            <p class="text-[#111418] dark:text-gray-200 text-base font-medium leading-normal pb-2">아이디
                                (이메일)</p>
                            <input id="email"
                                class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-[#111418] focus:outline-0 focus:ring-0 border border-[#dbe0e6] bg-white focus:border-primary h-14 placeholder:text-[#617589] p-[15px] text-base font-normal leading-normal dark:bg-background-dark dark:border-gray-600 dark:text-white dark:focus:border-primary"
                                placeholder="사용할 이메일 주소를 입력하세요" type="email" value="" />
                        </label>
                    </div>
                    <div class="flex w-full flex-wrap items-end">
                        <label class="flex flex-col min-w-40 flex-1">
                            <p class="text-[#111418] dark:text-gray-200 text-base font-medium leading-normal pb-2">비밀번호
                            </p>
                            <input id="password"
                                class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-[#111418] focus:outline-0 focus:ring-0 border border-[#dbe0e6] bg-white focus:border-primary h-14 placeholder:text-[#617589] p-[15px] text-base font-normal leading-normal dark:bg-background-dark dark:border-gray-600 dark:text-white dark:focus:border-primary"
                                placeholder="비밀번호를 입력하세요 (최소 6자)" type="password" value="" />
                        </label>
                    </div>
                    <div class="flex w-full flex-wrap items-end">
                        <label class="flex flex-col min-w-40 flex-1">
                            <p class="text-[#111418] dark:text-gray-200 text-base font-medium leading-normal pb-2">비밀번호
                                확인</p>
                            <input id="passwordConfirm"
                                class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-[#111418] focus:outline-0 focus:ring-0 border border-[#dbe0e6] bg-white focus:border-primary h-14 placeholder:text-[#617589] p-[15px] text-base font-normal leading-normal dark:bg-background-dark dark:border-gray-600 dark:text-white dark:focus:border-primary"
                                placeholder="비밀번호를 다시 입력하세요" type="password" value="" />
                        </label>
                    </div>
                    <button id="signupBtn"
                        class="flex w-full items-center justify-center rounded-lg bg-primary h-14 px-6 text-base font-bold text-white shadow-sm hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 mt-6">
                        회원가입 완료
                    </button>
                    <div class="text-center pt-4">
                        <p class="text-sm text-[#617589] dark:text-gray-400">이미 계정이 있으신가요? <a
                                class="font-bold text-primary hover:underline" href="login">로그인</a></p>
                    </div>
                </div>
            </div>
            
        </main>
    </div>

    <!-- JavaScript 파일들 -->
    <script src="js/config.js"></script>
    <script src="js/supabase.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/toast.js"></script>
    <script src="js/page-transition.js"></script>
    
    <script>
        // 회원가입 페이지 초기화
        let memberData = null; // Step 1에서 검증된 회원 데이터 저장

        document.addEventListener('DOMContentLoaded', async () => {
            // 이미 로그인된 경우 메인으로 리디렉션
            await requireGuest();

            // Step 1: 회원 검증
            const verifyBtn = document.getElementById('verifyBtn');
            const nameInput = document.getElementById('name');
            const birthDateInput = document.getElementById('birthDate');
            const phoneInput = document.getElementById('phone');

            // 숫자만 입력 (생년월일, 전화번호)
            birthDateInput.addEventListener('input', (e) => {
                e.target.value = e.target.value.replace(/[^0-9]/g, '');
            });
            phoneInput.addEventListener('input', (e) => {
                e.target.value = e.target.value.replace(/[^0-9]/g, '');
            });

            verifyBtn.addEventListener('click', async () => {
                const name = nameInput.value.trim();
                const birthDate = birthDateInput.value.trim();
                const phone = phoneInput.value.trim();

                // 유효성 검사
                if (!name) {
                    showError('이름을 입력하세요.');
                    return;
                }
                if (birthDate.length !== 8) {
                    showError('생년월일 8자리를 정확히 입력하세요. (예: 19900115)');
                    return;
                }
                if (phone.length < 10 || phone.length > 11) {
                    showError('휴대폰 번호를 정확히 입력하세요.');
                    return;
                }

                // 날짜 형식 변환 (YYYYMMDD -> YYYY-MM-DD)
                const formattedBirthDate = `${birthDate.substring(0, 4)}-${birthDate.substring(4, 6)}-${birthDate.substring(6, 8)}`;

                setLoading('verifyBtn', true);
                verifyBtn.textContent = '검증 중...';

                try {
                    // 회원 검증
                    memberData = await verifyMember(name, formattedBirthDate, phone);
                    
                    showSuccess(`환영합니다, ${memberData.name}님! (${memberData.batch}기)\n이메일과 비밀번호를 설정해주세요.`);
                    
                    // Step 2로 전환
                    document.getElementById('signup-step-1').classList.add('hidden');
                    document.getElementById('signup-step-2').classList.remove('hidden');
                    
                } catch (error) {
                    showError(error.message || '등록된 회원 정보가 없거나 이미 가입되었습니다.\n이름, 생년월일, 전화번호를 다시 확인해주세요.');
                } finally {
                    setLoading('verifyBtn', false);
                    verifyBtn.textContent = '검증하기';
                }
            });

            // Step 2: 계정 생성
            const signupBtn = document.getElementById('signupBtn');
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const passwordConfirmInput = document.getElementById('passwordConfirm');

            signupBtn.addEventListener('click', async () => {
                const email = emailInput.value.trim();
                const password = passwordInput.value;
                const passwordConfirm = passwordConfirmInput.value;

                // 유효성 검사
                if (!email) {
                    showError('이메일을 입력하세요.');
                    return;
                }
                if (!email.includes('@')) {
                    showError('올바른 이메일 형식을 입력하세요.');
                    return;
                }
                if (!password) {
                    showError('비밀번호를 입력하세요.');
                    return;
                }
                if (password.length < 6) {
                    showError('비밀번호는 최소 6자 이상이어야 합니다.');
                    return;
                }
                if (password !== passwordConfirm) {
                    showError('비밀번호가 일치하지 않습니다.');
                    return;
                }

                setLoading('signupBtn', true);
                signupBtn.textContent = '가입 중...';

                try {
                    // 회원가입
                    await signUp(email, password, memberData);
                    
                    showSuccess('회원가입이 완료되었습니다!\n로그인 페이지로 이동합니다.');
                    
                    // 잠시 후 로그인 페이지로 이동
                    setTimeout(() => {
                        smoothNavigate('login.html');
                    }, 1500);
                    
                } catch (error) {
                    let errorMessage = '회원가입에 실패했습니다.';
                    
                    // 429 에러 처리
                    if (error.status === 429 || error.message?.includes('429') || error.message?.includes('Too Many Requests')) {
                        errorMessage = '⏱️ 잠시 후 다시 시도해주세요.\n(너무 많은 요청이 발생했습니다. 1-2분 후 재시도)';
                    }
                    // 이메일 중복 처리
                    else if (error.message?.includes('already registered') || error.message?.includes('User already registered')) {
                        errorMessage = '❌ 이미 사용 중인 이메일입니다.\n다른 이메일을 사용해주세요.';
                    }
                    // 기타 에러
                    else if (error.message) {
                        errorMessage = error.message;
                    }
                    
                    showError(errorMessage);
                    setLoading('signupBtn', false);
                    signupBtn.textContent = '회원가입 완료';
                }
            });
        });
    </script>
</body>

</html>