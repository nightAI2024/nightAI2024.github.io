<!DOCTYPE html>

<html class="light" lang="ko">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>알림 화면</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
        <meta name="description" content="CAIO 원우회 회원의 상세 프로필, 경력, 연락처 정보를 확인하세요.">
    <meta property="og:type" content="website">
    <meta property="og:title" content="CAIO 원우회 네트워크">
    <meta property="og:description" content="CAIO 원우회 회원의 상세 프로필, 경력, 연락처 정보를 확인하세요.">
    <meta name="twitter:title" content="CAIO 원우회 네트워크">
    <meta name="twitter:description" content="CAIO 원우회 회원의 상세 프로필, 경력, 연락처 정보를 확인하세요.">
    <meta property="og:image" content="https://raw.githubusercontent.com/nightAI2024/nightAI2024.github.io/refs/heads/main/img/og_image_c.png">
    <meta name="twitter:image" content="https://raw.githubusercontent.com/nightAI2024/nightAI2024.github.io/refs/heads/main/img/og_image_c.png">
    <link rel="manifest" href="/site.webmanifest">
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&amp;display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f9f9f9",
                        "background-dark": "#101922",
                        "text-light-primary": "#333333",
                        "text-light-secondary": "#888888",
                        "border-light": "#E0E0E0",
                        "text-dark-primary": "#f1f5f9",
                        "text-dark-secondary": "#94a3b8",
                        "border-dark": "#334155",
                        "surface-light": "#ffffff",
                        "surface-dark": "#1e293b",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
                },
            },
        }
    </script>
    <style>
        body {
            min-height: max(884px, 100dvh);
        }
    </style>
</head>

<body class="bg-background-light dark:bg-background-dark font-display">
    <div class="relative mx-auto flex h-auto min-h-screen w-full max-w-md flex-col bg-surface-light dark:bg-surface-dark group/design-root overflow-x-hidden">
        <!-- Top App Bar -->
        <header class="sticky top-0 z-10 flex flex-col bg-surface-light dark:bg-surface-dark">
            <div class="flex items-center p-4">
                <div class="flex size-10 shrink-0 items-center justify-center text-text-light-primary dark:text-text-dark-primary cursor-pointer" id="backBtn">
                    <span class="material-symbols-outlined text-2xl">arrow_back</span>
                </div>
                <h1 class="flex-1 text-center text-lg font-bold tracking-tight text-text-light-primary dark:text-text-dark-primary">
                    알림</h1>
                <div class="flex w-10 items-center justify-end">
                    <button id="markAllReadBtn" class="text-sm font-semibold text-text-light-secondary dark:text-text-dark-secondary">모두 읽음</button>
                </div>
            </div>
        </header>
        
        <!-- Notifications List -->
        <main id="notificationList" class="flex-1 divide-y divide-border-light dark:divide-border-dark">
            <div class="p-8 text-center text-text-light-secondary dark:text-text-dark-secondary">
                로딩 중...
            </div>
        </main>
    </div>

    <script src="js/config.js"></script>
    <script src="js/supabase.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/notification.js"></script>
    <script src="js/page-transition.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const session = await requireAuth();
            if (!session) return;

            const user = await getCurrentUser();
            const client = initSupabase();

            // 뒤로가기
            document.getElementById('backBtn').addEventListener('click', () => window.history.back());

            // 알림 로드
            await loadNotifications();

            // 모두 읽음 버튼
            document.getElementById('markAllReadBtn').addEventListener('click', async () => {
                try {
                    const { error } = await client
                        .from('notifications')
                        .update({ is_read: true })
                        .eq('user_id', user.id)
                        .eq('is_read', false);

                    if (error) throw error;

                    showSuccess('모든 알림을 읽음 처리했습니다.');
                    await loadNotifications();
                } catch (error) {
                    showError('알림 읽음 처리에 실패했습니다.');
                }
            });

            async function loadNotifications() {
                try {
                    // actor 프로필 정보도 함께 가져오기
                    const { data: notifications, error } = await client
                        .from('notifications')
                        .select(`
                            *,
                            actor:actor_id (
                                id,
                                name,
                                profile_image_url
                            )
                        `)
                        .eq('user_id', user.id)
                        .order('created_at', { ascending: false })
                        .limit(50);

                    if (error) throw error;

                    displayNotifications(notifications);
                } catch (error) {
                    document.getElementById('notificationList').innerHTML = 
                        '<p class="text-center text-red-500 py-8">알림을 불러오는데 실패했습니다.</p>';
                }
            }

            function displayNotifications(notifications) {
                const listEl = document.getElementById('notificationList');

                if (!notifications || notifications.length === 0) {
                    listEl.innerHTML = '<p class="text-center text-text-light-secondary dark:text-text-dark-secondary py-8">알림이 없습니다.</p>';
                    return;
                }

                listEl.innerHTML = notifications.map(notif => {
                    const iconMap = {
                        'community': 'chat_bubble',
                        'profile': 'person',
                        'system': 'notifications',
                        'notice': 'campaign'
                    };
                    
                    const icon = iconMap[notif.type] || 'notifications';
                    const isUnread = !notif.is_read;
                    
                    // actor 이름 포함한 메시지 생성
                    let displayMessage = notif.content || notif.message || '';
                    if (notif.actor && notif.actor.name) {
                        const actorName = notif.actor.name;
                        
                        // 메시지 타입에 따라 자연스러운 메시지 생성
                        if (notif.title === '새 댓글') {
                            displayMessage = `${actorName}님이 회원님의 게시글에 댓글을 달았습니다.`;
                        } else if (notif.title === '새 답글') {
                            displayMessage = `${actorName}님이 회원님의 댓글에 답글을 달았습니다.`;
                        } else if (notif.title === '새 좋아요') {
                            displayMessage = `${actorName}님이 회원님의 게시글을 좋아합니다.`;
                        } else if (notif.actor) {
                            // 다른 타입의 알림도 actor 이름 포함
                            displayMessage = `${actorName}님: ${displayMessage}`;
                        }
                    }

                    return `
                        <div class="flex gap-3 p-4 ${isUnread ? 'bg-blue-50 dark:bg-blue-900/20' : ''} hover:bg-gray-50 dark:hover:bg-gray-800/50 cursor-pointer transition-colors" data-id="${notif.id}" data-type="${notif.type}" data-link="${notif.link_url || ''}">
                            <div class="flex size-10 shrink-0 items-center justify-center rounded-full ${isUnread ? 'bg-primary/10' : 'bg-gray-100 dark:bg-gray-700'}">
                                <span class="material-symbols-outlined text-xl ${isUnread ? 'text-primary' : 'text-gray-500'}">${icon}</span>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm ${isUnread ? 'font-semibold' : 'font-normal'} text-text-light-primary dark:text-text-dark-primary">
                                    ${escapeHtml(displayMessage)}
                                </p>
                                <p class="text-xs text-text-light-secondary dark:text-text-dark-secondary mt-2">
                                    ${formatDate(notif.created_at)}
                                </p>
                            </div>
                            ${isUnread ? '<div class="flex shrink-0 items-start pt-1"><div class="h-2 w-2 rounded-full bg-primary"></div></div>' : ''}
                        </div>
                    `;
                }).join('');

                // 알림 클릭 이벤트
                listEl.querySelectorAll('[data-id]').forEach(item => {
                    item.addEventListener('click', async () => {
                        const notifId = item.dataset.id;
                        const linkUrl = item.dataset.link;

                        // 읽음 처리
                        await client
                            .from('notifications')
                            .update({ is_read: true })
                            .eq('id', notifId);

                        // 링크가 있으면 이동
                        if (linkUrl && linkUrl !== 'null' && linkUrl !== '') {
                            smoothNavigate(linkUrl, 300);
                        } else {
                            // 링크가 없으면 단순히 읽음 처리만
                            smoothReload(200);
                        }
                    });
                });
            }
        });
    </script>
</body>

</html>
