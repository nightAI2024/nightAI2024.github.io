<!DOCTYPE html>
<html class="light" lang="ko">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>CAIO Community</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <!-- Supabase JavaScript Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;family=Noto+Sans+KR:wght@400;500;700&amp;display=swap"
        rel="stylesheet" />
    <link href="css/fonts.css" rel="stylesheet" />
    <style>
        .material-symbols-outlined {
            font-variation-settings:
                'FILL' 0,
                'wght' 400,
                'GRAD' 0,
                'opsz' 24
        }
    </style>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                        "foreground-light": "#ffffff",
                        "foreground-dark": "#1a2836",
                        "text-primary-light": "#111418",
                        "text-primary-dark": "#f0f2f4",
                        "text-secondary-light": "#617589",
                        "text-secondary-dark": "#a0b3c6",
                        "border-light": "#e3e8ed",
                        "border-dark": "#2c3e50"
                    },
                    fontFamily: {
                        "display": ["Noto Sans KR", "Inter", "sans-serif"]
                    },
                    borderRadius: { "DEFAULT": "0.5rem", "lg": "0.75rem", "xl": "1rem", "full": "9999px" },
                },
            },
        }
    </script>
</head>

<body class="font-display bg-background-light dark:bg-background-dark">
    <div class="relative flex min-h-screen w-full flex-col group/design-root overflow-x-hidden">
        <header
            class="sticky top-0 z-10 flex flex-col bg-foreground-light dark:bg-foreground-dark border-b border-border-light dark:border-border-dark">
            <div class="flex h-16 items-center justify-center px-4">
                <h1
                    class="text-lg font-bold text-text-primary-light dark:text-text-primary-dark tracking-tight">
                    CAIO 커뮤니티</h1>
            </div>
        </header>
        <main class="flex-1 pb-20">
            <div
                class="sticky top-16 z-10 bg-foreground-light dark:bg-foreground-dark border-b border-border-light dark:border-border-dark px-4 py-3">
                <div class="flex items-center gap-2 overflow-x-auto">
                    <button id="filterRecent" class="px-4 py-2 rounded-full bg-primary text-white text-sm font-semibold shrink-0">최신글</button>
                    <button id="filterPopular"
                        class="px-4 py-2 rounded-full bg-background-light dark:bg-foreground-dark text-text-secondary-light dark:text-text-primary-dark text-sm font-medium shrink-0">인기글</button>
                    <button id="filterMy"
                        class="px-4 py-2 rounded-full bg-background-light dark:bg-foreground-dark text-text-secondary-light dark:text-text-primary-dark text-sm font-medium shrink-0">내 글</button>
                    <button id="filterMyComments"
                        class="px-4 py-2 rounded-full bg-background-light dark:bg-foreground-dark text-text-secondary-light dark:text-text-primary-dark text-sm font-medium shrink-0">내
                        댓글</button>
                </div>
            </div>
            <div id="postList" class="flex flex-col">
                <p class="text-center text-text-secondary-light dark:text-text-secondary-dark py-8">로딩 중...</p>
            </div>
        </main>
        <!-- 글쓰기 버튼 (네비바 위로 조정) -->
        <a href="community_write.html" class="fixed bottom-24 right-6 z-20">
            <button class="flex items-center justify-center w-14 h-14 rounded-full bg-primary text-white shadow-lg hover:bg-primary/90 transition-colors">
                <span class="material-symbols-outlined text-3xl">edit</span>
            </button>
        </a>
    </div>
    
    <!-- 하단 네비게이션 -->
    <nav class="fixed bottom-0 left-0 right-0 h-20 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 flex justify-around items-center px-2 z-30">
        <a class="flex flex-col items-center justify-center gap-1 w-full text-gray-500 dark:text-gray-400" href="main.html">
            <span class="material-symbols-outlined !text-3xl">home</span>
            <span class="text-xs font-medium">홈</span>
        </a>
        <a class="flex flex-col items-center justify-center gap-1 w-full text-gray-500 dark:text-gray-400" href="contact.html">
            <span class="material-symbols-outlined !text-3xl">group</span>
            <span class="text-xs font-medium">명부</span>
        </a>
        <a class="flex flex-col items-center justify-center gap-1 w-full text-primary" href="community.html">
            <span class="material-symbols-outlined !text-3xl" style="font-variation-settings: 'FILL' 1;">chat</span>
            <span class="text-xs font-bold">커뮤니티</span>
        </a>
        <a class="flex flex-col items-center justify-center gap-1 w-full text-gray-500 dark:text-gray-400" href="my_profile.html">
            <span class="material-symbols-outlined !text-3xl">person</span>
            <span class="text-xs font-medium">마이페이지</span>
        </a>
    </nav>

    <!-- JavaScript 파일들 -->
    <script src="js/config.js"></script>
    <script src="js/supabase.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/admin.js"></script>
    <script src="js/community.js"></script>
    <script src="js/profile-utils.js"></script>
    <script src="js/page-transition.js"></script>
    
    <script>
        let currentFilter = 'recent'; // recent, popular, my, myComments
        let currentUser = null;
        let loadedPosts = []; // 현재 로드된 게시글 목록
        let currentOffset = 0; // 현재 오프셋
        let isLoading = false; // 로딩 중 여부
        let hasMorePosts = true; // 더 불러올 게시글이 있는지
        let allPopularPosts = []; // 인기글의 경우 모든 게시글 저장

        // 페이지 초기화
        document.addEventListener('DOMContentLoaded', async () => {
            // 로그인 확인
            const session = await requireAuth();
            if (!session) return;

            currentUser = await getCurrentUser();

            // 게시글 로드 (초기화)
            resetAndLoadPosts();

            // 필터 버튼 이벤트 리스너
            document.getElementById('filterRecent').addEventListener('click', () => {
                setFilter('recent');
            });
            document.getElementById('filterPopular').addEventListener('click', () => {
                setFilter('popular');
            });
            document.getElementById('filterMy').addEventListener('click', () => {
                setFilter('my');
            });
            document.getElementById('filterMyComments').addEventListener('click', () => {
                setFilter('myComments');
            });
        });

        // 필터 설정
        function setFilter(filter) {
            currentFilter = filter;

            // 버튼 스타일 업데이트
            const buttons = {
                'recent': document.getElementById('filterRecent'),
                'popular': document.getElementById('filterPopular'),
                'my': document.getElementById('filterMy'),
                'myComments': document.getElementById('filterMyComments')
            };

            Object.entries(buttons).forEach(([key, btn]) => {
                if (key === filter) {
                    btn.className = 'px-4 py-2 rounded-full bg-primary text-white text-sm font-semibold';
                } else {
                    btn.className = 'px-4 py-2 rounded-full bg-background-light dark:bg-foreground-dark text-text-secondary-light dark:text-text-primary-dark text-sm font-medium';
                }
            });

            // 게시글 다시 로드 (초기화)
            resetAndLoadPosts();
        }
        
        // 게시글 초기화 및 로드
        function resetAndLoadPosts() {
            loadedPosts = [];
            currentOffset = 0;
            hasMorePosts = true;
            allPopularPosts = [];
            loadPosts(true);
        }

        // 게시글 로드
        async function loadPosts(isInitial = false) {
            if (isLoading || !hasMorePosts) return;
            
            try {
                isLoading = true;
                const client = initSupabase();
                const postListEl = document.getElementById('postList');
                
                // 초기 로드일 때만 로딩 표시
                if (isInitial) {
                    postListEl.innerHTML = '<p class="text-center text-text-secondary-light dark:text-text-secondary-dark py-8">로딩 중...</p>';
                } else {
                    // 추가 로드 시 로딩 인디케이터 추가
                    const loadingIndicator = document.createElement('div');
                    loadingIndicator.id = 'loadingIndicator';
                    loadingIndicator.className = 'text-center py-4';
                    loadingIndicator.innerHTML = '<p class="text-text-secondary-light dark:text-text-secondary-dark text-sm">게시글을 불러오는 중...</p>';
                    postListEl.appendChild(loadingIndicator);
                }
                
                if (currentFilter === 'popular') {
                    // 인기글: 최근 14일 내 게시글, 좋아요 많은 순
                    if (isInitial) {
                        const fourteenDaysAgo = new Date();
                        fourteenDaysAgo.setDate(fourteenDaysAgo.getDate() - 14);
                        
                        // 14일 이내 게시글 가져오기 (전체)
                        const { data: posts, error } = await client
                            .from('posts')
                            .select(`
                                id,
                                content,
                                created_at,
                                author_id,
                                profiles:author_id (
                                    id,
                                    name,
                                    batch,
                                    company,
                                    position,
                                    profile_image_url
                                )
                            `)
                            .eq('is_deleted', false)
                            .gte('created_at', fourteenDaysAgo.toISOString())
                            .order('created_at', { ascending: false });
                        
                        if (error) throw error;
                        
                        if (!posts || posts.length === 0) {
                            postListEl.innerHTML = 
                                '<p class="text-center text-text-secondary-light dark:text-text-secondary-dark py-8">최근 14일 내 게시글이 없습니다.</p>';
                            isLoading = false;
                            return;
                        }
                        
                        // 각 게시글의 좋아요 수 계산
                        const postsWithLikes = await Promise.all(posts.map(async (post) => {
                            const { count } = await client
                                .from('post_likes')
                                .select('*', { count: 'exact', head: true })
                                .eq('post_id', post.id);
                            
                            return {
                                ...post,
                                likeCount: count || 0
                            };
                        }));
                        
                        // 좋아요 수로 정렬 (많은 순)
                        postsWithLikes.sort((a, b) => b.likeCount - a.likeCount);
                        
                        // 좋아요가 1개 이상인 게시글만 필터링
                        allPopularPosts = postsWithLikes.filter(post => post.likeCount > 0);
                        
                        if (allPopularPosts.length === 0) {
                            postListEl.innerHTML = 
                                '<p class="text-center text-text-secondary-light dark:text-text-secondary-dark py-8">인기글이 없습니다. 좋아요를 눌러 추천해주세요!</p>';
                            isLoading = false;
                            return;
                        }
                    }
                    
                    // 다음 20개 가져오기
                    const startIndex = currentOffset;
                    const endIndex = startIndex + 20;
                    const nextPosts = allPopularPosts.slice(startIndex, endIndex);
                    
                    if (nextPosts.length === 0) {
                        hasMorePosts = false;
                        isLoading = false;
                        const loadingIndicator = document.getElementById('loadingIndicator');
                        if (loadingIndicator) loadingIndicator.remove();
                        return;
                    }
                    
                    currentOffset = endIndex;
                    hasMorePosts = endIndex < allPopularPosts.length;
                    
                    await displayPosts(nextPosts, !isInitial);
                } else if (currentFilter === 'my') {
                    // 내가 쓴 글
                    if (!currentUser) {
                        postListEl.innerHTML = 
                            '<p class="text-center text-text-secondary-light dark:text-text-secondary-dark py-8">로그인이 필요합니다.</p>';
                        isLoading = false;
                        return;
                    }
                    
                    const { data: posts, error } = await client
                        .from('posts')
                        .select(`
                            id,
                            content,
                            created_at,
                            author_id,
                            profiles:author_id (
                                id,
                                name,
                                batch,
                                company,
                                position,
                                profile_image_url
                            )
                        `)
                        .eq('is_deleted', false)
                        .eq('author_id', currentUser.id)
                        .order('created_at', { ascending: false })
                        .range(currentOffset, currentOffset + 19);

                    if (error) throw error;

                    if (!posts || posts.length === 0) {
                        if (isInitial) {
                            postListEl.innerHTML = 
                                '<p class="text-center text-text-secondary-light dark:text-text-secondary-dark py-8">작성한 게시글이 없습니다.</p>';
                        } else {
                            hasMorePosts = false;
                            const loadingIndicator = document.getElementById('loadingIndicator');
                            if (loadingIndicator) loadingIndicator.remove();
                        }
                        isLoading = false;
                        return;
                    }

                    currentOffset += posts.length;
                    hasMorePosts = posts.length === 20;

                    await displayPosts(posts, !isInitial);
                } else if (currentFilter === 'myComments') {
                    // 내 댓글이 달린 게시글
                    if (!currentUser) {
                        postListEl.innerHTML = 
                            '<p class="text-center text-text-secondary-light dark:text-text-secondary-dark py-8">로그인이 필요합니다.</p>';
                        isLoading = false;
                        return;
                    }
                    
                    let uniquePostIds = [];
                    
                    if (isInitial) {
                        // 내가 작성한 댓글들의 post_id 가져오기
                        const { data: myComments, error: commentsError } = await client
                            .from('comments')
                            .select('post_id')
                            .eq('author_id', currentUser.id)
                            .eq('is_deleted', false);
                        
                        if (commentsError) throw commentsError;
                        
                        if (!myComments || myComments.length === 0) {
                            postListEl.innerHTML = 
                                '<p class="text-center text-text-secondary-light dark:text-text-secondary-dark py-8">댓글을 작성한 게시글이 없습니다.</p>';
                            isLoading = false;
                            return;
                        }
                        
                        // 중복 제거된 post_id 목록 저장
                        uniquePostIds = [...new Set(myComments.map(c => c.post_id))];
                        // 전역 변수에 저장하여 다음 로드 시 재사용
                        window.myCommentPostIds = uniquePostIds;
                    } else {
                        uniquePostIds = window.myCommentPostIds || [];
                    }
                    
                    // 해당 게시글들 가져오기 (범위 지정)
                    const { data: posts, error } = await client
                        .from('posts')
                        .select(`
                            id,
                            content,
                            created_at,
                            author_id,
                            profiles:author_id (
                                id,
                                name,
                                batch,
                                company,
                                position,
                                profile_image_url
                            )
                        `)
                        .eq('is_deleted', false)
                        .in('id', uniquePostIds)
                        .order('created_at', { ascending: false })
                        .range(currentOffset, currentOffset + 19);

                    if (error) throw error;

                    if (!posts || posts.length === 0) {
                        if (isInitial) {
                            postListEl.innerHTML = 
                                '<p class="text-center text-text-secondary-light dark:text-text-secondary-dark py-8">게시글이 없습니다.</p>';
                        } else {
                            hasMorePosts = false;
                            const loadingIndicator = document.getElementById('loadingIndicator');
                            if (loadingIndicator) loadingIndicator.remove();
                        }
                        isLoading = false;
                        return;
                    }

                    currentOffset += posts.length;
                    hasMorePosts = posts.length === 20;

                    await displayPosts(posts, !isInitial);
                } else {
                    // 최신글 (기본)
                    const { data: posts, error } = await client
                        .from('posts')
                        .select(`
                            id,
                            content,
                            created_at,
                            author_id,
                            profiles:author_id (
                                id,
                                name,
                                batch,
                                company,
                                position,
                                profile_image_url
                            )
                        `)
                        .eq('is_deleted', false)
                        .order('created_at', { ascending: false })
                        .range(currentOffset, currentOffset + 19);

                    if (error) throw error;

                    if (!posts || posts.length === 0) {
                        if (isInitial) {
                            postListEl.innerHTML = 
                                '<p class="text-center text-text-secondary-light dark:text-text-secondary-dark py-8">게시글이 없습니다.</p>';
                        } else {
                            hasMorePosts = false;
                            const loadingIndicator = document.getElementById('loadingIndicator');
                            if (loadingIndicator) loadingIndicator.remove();
                        }
                        isLoading = false;
                        return;
                    }

                    currentOffset += posts.length;
                    hasMorePosts = posts.length === 20;

                    await displayPosts(posts, !isInitial);
                }
            } catch (error) {
                if (isInitial) {
                    document.getElementById('postList').innerHTML = 
                        '<p class="text-center text-red-500 py-8">게시글을 불러오는데 실패했습니다.</p>';
                } else {
                    const loadingIndicator = document.getElementById('loadingIndicator');
                    if (loadingIndicator) loadingIndicator.remove();
                }
            } finally {
                isLoading = false;
            }
        }

        // 게시글 표시
        async function displayPosts(posts, append = false) {
            const postListEl = document.getElementById('postList');
            
            // 로딩 인디케이터 제거
            const loadingIndicator = document.getElementById('loadingIndicator');
            if (loadingIndicator) loadingIndicator.remove();

            if (!posts || posts.length === 0) {
                if (!append) {
                    postListEl.innerHTML = '<p class="text-center text-text-secondary-light dark:text-text-secondary-dark py-8">게시글이 없습니다.</p>';
                }
                return;
            }
            
            // 기존 게시글에 추가하거나 새로 표시
            if (append) {
                loadedPosts = [...loadedPosts, ...posts];
            } else {
                loadedPosts = posts;
            }

            // 각 게시글의 좋아요 수, 댓글 수, 최신 경력 정보 가져오기
            const client = initSupabase();
            const postsWithCounts = await Promise.all(posts.map(async (post) => {
                // 인기글 필터에서 이미 likeCount가 있는 경우 재사용
                let likeCount = post.likeCount;
                let commentCount = post.commentCount;
                
                if (likeCount === undefined || commentCount === undefined) {
                    const [likes, comments] = await Promise.all([
                        likeCount === undefined ? client.from('post_likes').select('*', { count: 'exact', head: true }).eq('post_id', post.id) : { count: likeCount },
                        commentCount === undefined ? client.from('comments').select('*', { count: 'exact', head: true }).eq('post_id', post.id).eq('is_deleted', false) : { count: commentCount }
                    ]);
                    
                    likeCount = likes.count || 0;
                    commentCount = comments.count || 0;
                }

                // 최신 경력 정보 가져오기
                let latestCareer = null;
                if (post.profiles?.id) {
                    const { data: careers, error: careerError } = await client
                        .from('careers')
                        .select('company, position, end_year, start_year, order')
                        .eq('profile_id', post.profiles.id);
                    
                    if (!careerError && careers && careers.length > 0) {
                        // 최신 경력 선택 로직:
                        // 사용자가 설정한 순서(order)를 최우선으로 고려
                        // order가 작을수록 맨 위에 설정한 경력이므로 우선순위가 높음
                        const sortedCareers = careers.sort((a, b) => {
                            // 1. order가 가장 작은 것 우선 (맨 위에 설정한 경력)
                            const orderA = a.order !== null && a.order !== undefined ? a.order : 999;
                            const orderB = b.order !== null && b.order !== undefined ? b.order : 999;
                            if (orderA !== orderB) {
                                return orderA - orderB;
                            }
                            
                            // 2. order가 같으면 현재 재직 중인 것 우선
                            if (!a.end_year && b.end_year) return -1;
                            if (a.end_year && !b.end_year) return 1;
                            
                            // 3. 둘 다 재직 중이거나 둘 다 종료한 경우
                            if (!a.end_year && !b.end_year) {
                                // 둘 다 재직 중이면 start_year가 큰 것 (최근에 시작한 것)
                                if (a.start_year && b.start_year) {
                                    const yearDiff = parseInt(b.start_year) - parseInt(a.start_year);
                                    if (yearDiff !== 0) return yearDiff;
                                }
                                return 0;
                            }
                            
                            // 4. 둘 다 종료한 경우 end_year가 큰 것 (최근에 종료한 것)
                            if (a.end_year && b.end_year) {
                                const yearDiff = parseInt(b.end_year) - parseInt(a.end_year);
                                if (yearDiff !== 0) return yearDiff;
                                // end_year가 같으면 start_year가 큰 것
                                if (a.start_year && b.start_year) {
                                    const startDiff = parseInt(b.start_year) - parseInt(a.start_year);
                                    if (startDiff !== 0) return startDiff;
                                }
                            }
                            
                            return 0;
                        });
                        latestCareer = sortedCareers[0];
                    }
                }

                return {
                    ...post,
                    likeCount,
                    commentCount,
                    latestCareer
                };
            }));

            const postsHTML = postsWithCounts.map(post => {
                // 최신 경력 정보 또는 프로필의 기본 정보 사용
                const company = post.latestCareer?.company || post.profiles?.company || '';
                const position = post.latestCareer?.position || post.profiles?.position || '';
                const careerText = company && position ? `${company}, ${position}` : (company || position || '');
                
                return `
                <a href="community_detail.html?id=${post.id}"
                    class="flex gap-4 bg-foreground-light dark:bg-foreground-dark px-4 py-4 border-b border-border-light dark:border-border-dark hover:bg-gray-50 dark:hover:bg-white/5 transition-colors">
                    <div class="flex flex-col items-center shrink-0">
                        <div class="aspect-square rounded-full h-12 w-12 overflow-hidden flex items-center justify-center">
                            ${createProfileAvatar(post.profiles)}
                        </div>
                        <span
                            class="mt-1.5 inline-flex items-center justify-center rounded-full bg-primary/10 px-2 py-0.5 text-xs font-semibold text-primary">${post.profiles?.batch || '?'}기</span>
                    </div>
                    <div class="flex flex-col flex-1 gap-2">
                        <div class="flex items-center gap-2">
                            <p
                                class="text-text-primary-light dark:text-text-primary-dark text-base font-semibold leading-normal">
                                ${escapeHtml(post.profiles?.name || '익명')}</p>
                        </div>
                        <div class="flex items-center gap-2 -mt-1">
                            ${careerText ? `<p
                                class="text-text-secondary-light dark:text-text-secondary-dark text-sm font-normal leading-normal">
                                ${escapeHtml(careerText)}</p>
                            <span class="text-text-secondary-light dark:text-text-secondary-dark text-sm">·</span>` : ''}
                            <p
                                class="text-text-secondary-light dark:text-text-secondary-dark text-sm font-normal leading-normal">
                                ${formatDate(post.created_at)}</p>
                        </div>
                        <p
                            class="text-text-primary-light dark:text-text-primary-dark text-base font-normal leading-relaxed mt-1 line-clamp-3">
                            ${escapeHtml(post.content)}</p>
                        <div
                            class="flex items-center gap-6 mt-2 text-text-secondary-light dark:text-text-secondary-dark">
                            <div class="flex items-center gap-1.5">
                                <span class="material-symbols-outlined text-xl">thumb_up</span>
                                <span class="text-sm font-medium">${post.likeCount}</span>
                            </div>
                            <div class="flex items-center gap-1.5">
                                <span class="material-symbols-outlined text-xl">chat_bubble_outline</span>
                                <span class="text-sm font-medium">${post.commentCount}</span>
                            </div>
                        </div>
                    </div>
                </a>
            `;
            }).join('');
            
            if (append) {
                postListEl.insertAdjacentHTML('beforeend', postsHTML);
            } else {
                postListEl.innerHTML = postsHTML;
            }
        }
        
        // 무한 스크롤 이벤트 리스너
        let scrollTimeout;
        window.addEventListener('scroll', () => {
            // 스크롤 이벤트 디바운싱
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(() => {
                // 스크롤이 하단 200px 이내에 도달하면 다음 게시글 로드
                const scrollHeight = document.documentElement.scrollHeight;
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                const clientHeight = window.innerHeight;
                
                if (scrollHeight - scrollTop - clientHeight < 200) {
                    if (!isLoading && hasMorePosts) {
                        loadPosts(false);
                    }
                }
            }, 100);
        });
    </script>
</body>

</html>
